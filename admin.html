<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | ‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="admin-page">

    <div id="admin-login" class="overlay">
        <div class="card login-card">
            <h2>‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin)</h2>
            <input type="password" id="admin-password" placeholder="‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">
            <button onclick="checkAdminLogin()" class="btn-main">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <div id="admin-content" class="container" style="display:none; max-width: 1200px;">
        <header style="position:relative;">
            <h1>‡πÅ‡∏ú‡∏á‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</h1>
            <p>‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢ ‡πÉ‡∏ô‡∏û‡∏£‡∏∞‡∏ö‡∏£‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏ä‡∏π‡∏õ‡∏ñ‡∏±‡∏°‡∏†‡πå</p>
            <button onclick="logout()" style="position:absolute; top:10px; right:0; padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </header>

        <div class="card admin-controls">
            <!-- ‚úÖ ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î ‡πÅ‡∏¢‡∏Å ‡∏°.‡∏ï‡πâ‡∏ô / ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢ -->
            <div class="card" style="margin-bottom:15px; padding:15px;">
                <h3 style="margin:0 0 10px 0;">‚è∞ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏°‡∏±‡∏Ñ‡∏£</h3>
                <div style="display:flex; flex-direction:column; gap:10px;">
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                        <strong style="width:80px;">‡∏°.‡∏ï‡πâ‡∏ô</strong>
                        <label>‡πÄ‡∏õ‡∏¥‡∏î: <input type="datetime-local" id="juniorOpen"></label>
                        <label>‡∏õ‡∏¥‡∏î: <input type="datetime-local" id="juniorClose"></label>
                    </div>
                    <div style="display:flex; gap:15px; flex-wrap:wrap; align-items:center;">
                        <strong style="width:80px;">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</strong>
                        <label>‡πÄ‡∏õ‡∏¥‡∏î: <input type="datetime-local" id="seniorOpen"></label>
                        <label>‡∏õ‡∏¥‡∏î: <input type="datetime-local" id="seniorClose"></label>
                    </div>
                    <div>
                        <button onclick="saveTime()" class="btn-main" style="padding:8px 20px;">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
                        <span id="timeStatus" style="color:green; margin-left:10px;"></span>
                    </div>
                </div>
            </div>

            <div class="toolbar">
                <div class="filter-btns">
                    <button onclick="filterByLevel('all')" class="btn-sub active">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                    <button onclick="filterByLevel('junior')" class="btn-sub">‡∏°.‡∏ï‡πâ‡∏ô</button>
                    <button onclick="filterByLevel('senior')" class="btn-sub">‡∏°.‡∏õ‡∏•‡∏≤‡∏¢</button>
                </div>
                <input type="text" id="adminSearch" onkeyup="searchTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡∏ä‡∏∑‡πà‡∏≠ / ‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß / ‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°...">
                <button onclick="exportExcel()" class="btn-export">Export to Excel</button>
            </div>

            <div class="table-wrapper">
                <table id="registrationTable">
                    <thead>
                        <tr>
                            <th>‡∏ß/‡∏î/‡∏õ</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th>‡∏´‡πâ‡∏≠‡∏á</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</th>
                            <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                        </tr>
                    </thead>
                    <tbody id="adminTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIEF0K4z7d9i1YnCVqTpXoaA_chCOBCS3SPIdM1sTz1afydtgfGmjY8a2jz9oKpUQc/exec";
        let allData = [];

        // 1. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ä‡πá‡∏Ñ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô
        function checkAdminLogin() {
            const pass = document.getElementById('admin-password').value;
            if (pass === "12345") {
                sessionStorage.setItem('adminLoggedIn', 'true');
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadData();
                loadTime();
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            }
        }

        // 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets
        async function loadData() {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = "<tr><td colspan='9'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";
            try {
                const response = await fetch(SCRIPT_URL + "?action=read");
                allData = await response.json();
                renderTable(allData);
            } catch (err) {
                tbody.innerHTML = "<tr><td colspan='9'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
            }
        }

        // 3. ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function renderTable(data) {
            const tbody = document.getElementById('adminTableBody');
            tbody.innerHTML = "";
            data.slice(1).forEach((row) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td>${row[5]}</td>
                    <td>${row[6]}</td>
                    <td class="club-cell">${row[7]}</td>
                    <td><button class="btn-del" onclick="deleteData('${row[3]}')">‡∏•‡∏ö</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        function searchTable() {
            const input = document.getElementById("adminSearch").value.toLowerCase();
            const rows = document.getElementById("adminTableBody").getElementsByTagName("tr");
            for (let row of rows) {
                row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
            }
        }

        // 5. ‡πÅ‡∏¢‡∏Å‡∏î‡∏π ‡∏°.‡∏ï‡πâ‡∏ô / ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢
        function filterByLevel(level) {
            let filtered = [];
            if (level === 'all') {
                filtered = allData;
            } else {
                filtered = allData.filter((row, index) => {
                    if (index === 0) return true;
                    const grade = parseInt(String(row[5]).split('/')[0]);
                    return level === 'junior' ? grade <= 3 : grade >= 4;
                });
            }
            renderTable(filtered);
        }

        // 6. Export ‡πÄ‡∏õ‡πá‡∏ô Excel
        function exportExcel() {
            const exportData = allData.slice(1).map(row => ({
                "‡∏ß/‡∏î/‡∏õ":         row[0],
                "‡πÄ‡∏ß‡∏•‡∏≤":          row[1],
                "‡∏≠‡∏µ‡πÄ‡∏°‡∏•":         row[2],
                "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß":  String(row[3]).replace("'", ""),
                "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà":        row[4],
                "‡∏´‡πâ‡∏≠‡∏á":         String(row[5]).replace("'", ""),
                "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": row[6],
                "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°":        row[7]
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
            XLSX.writeFile(wb, "‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°_2569.xlsx");
        }

        // 7. ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î
        async function loadTime() {
            const res = await fetch(SCRIPT_URL + "?action=getTime");
            const data = await res.json();
            if (data.juniorOpen)  document.getElementById('juniorOpen').value  = data.juniorOpen;
            if (data.juniorClose) document.getElementById('juniorClose').value = data.juniorClose;
            if (data.seniorOpen)  document.getElementById('seniorOpen').value  = data.seniorOpen;
            if (data.seniorClose) document.getElementById('seniorClose').value = data.seniorClose;
        }

        // 8. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏õ‡∏¥‡∏î-‡∏õ‡∏¥‡∏î
        async function saveTime() {
            const juniorOpen  = document.getElementById('juniorOpen').value;
            const juniorClose = document.getElementById('juniorClose').value;
            const seniorOpen  = document.getElementById('seniorOpen').value;
            const seniorClose = document.getElementById('seniorClose').value;
            if (!juniorOpen || !juniorClose || !seniorOpen || !seniorClose) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ó‡∏±‡πâ‡∏á ‡∏°.‡∏ï‡πâ‡∏ô ‡πÅ‡∏•‡∏∞ ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢");
                return;
            }
            await fetch(`${SCRIPT_URL}?action=setTime&juniorOpen=${encodeURIComponent(juniorOpen)}&juniorClose=${encodeURIComponent(juniorClose)}&seniorOpen=${encodeURIComponent(seniorOpen)}&seniorClose=${encodeURIComponent(seniorClose)}`);
            document.getElementById('timeStatus').innerText = "‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß!";
            setTimeout(() => document.getElementById('timeStatus').innerText = "", 3000);
        }

        // 9. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        async function deleteData(studentId) {
            if (confirm(`‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß ${studentId}?`)) {
                try {
                    const res = await fetch(`${SCRIPT_URL}?action=delete&studentId=${encodeURIComponent(studentId)}`);
                    const result = await res.json();
                    if (result.status === "success") {
                        alert("‚úÖ ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
                        loadData();
                    } else {
                        alert("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
                    }
                } catch (err) {
                    alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
                }
            }
        }

        // 10. ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function logout() {
            sessionStorage.removeItem('adminLoggedIn');
            document.getElementById('admin-content').style.display = 'none';
            document.getElementById('admin-login').style.display = 'flex';
            document.getElementById('admin-password').value = '';
        }

        // 11. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = function() {
            if (sessionStorage.getItem('adminLoggedIn') === 'true') {
                document.getElementById('admin-login').style.display = 'none';
                document.getElementById('admin-content').style.display = 'block';
                loadData();
                loadTime();
            }
        }
    </script>

    <style>
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { width: 300px; text-align: center; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        #adminSearch { flex-grow: 1; padding: 10px; border: 1px solid #ddd; border-radius: 5px; }
        .table-wrapper { overflow-x: auto; background: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background-color: var(--br-red); color: white; }
        .club-cell { font-weight: bold; color: var(--br-red); }
        .btn-export { background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; }
        .btn-del { background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; }
        .btn-sub { padding: 8px 15px; border: 1px solid var(--br-red); background: white; color: var(--br-red); border-radius: 5px; cursor: pointer; }
        .btn-sub.active { background: var(--br-red); color: white; }
    </style>
</body>
</html>
