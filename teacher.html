<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° | ‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="admin-page">

    <!-- ‡∏´‡∏ô‡πâ‡∏≤ Login ‡∏Ñ‡∏£‡∏π -->
    <div id="teacher-login" class="overlay">
        <div class="card login-card">
            <h2>‡∏Ñ‡∏£‡∏π‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h2>
            <p style="color:#666; font-size:14px; margin-bottom:15px;">‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏ö‡∏ç‡∏à‡∏°‡∏£‡∏≤‡∏ä‡∏≤‡∏•‡∏±‡∏¢</p>
            <input type="email" id="teacher-email" placeholder="‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ñ‡∏£‡∏π (@br.ac.th)">
            <input type="password" id="teacher-password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" style="margin-top:10px;">
            <button onclick="checkTeacherLogin()" class="btn-main" style="margin-top:10px;">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
    </div>

    <!-- ‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏° -->
    <div id="teacher-content" class="container" style="display:none; max-width: 1200px;">
        <header style="position:relative;">
            <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</h1>
            <p id="teacher-info" style="color:#666;"></p>
            <button onclick="logoutTeacher()" style="position:absolute; top:10px; right:0; padding:8px 16px; background:#6c757d; color:white; border:none; border-radius:5px; cursor:pointer;">üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </header>

        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; flex-wrap:wrap; gap:10px;">
                <div>
                    <span id="club-name-display" style="font-size:18px; font-weight:bold; color:var(--br-red);"></span>
                    <span id="student-count" style="margin-left:15px; color:#666;"></span>
                </div>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="teacherSearch" onkeyup="searchTable()" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô..." style="padding:8px; border:1px solid #ddd; border-radius:5px;">
                    <button onclick="exportExcel()" class="btn-export">üì• Export Excel</button>
                </div>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>‡∏ß/‡∏î/‡∏õ</th>
                            <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
                            <th>‡∏≠‡∏µ‡πÄ‡∏°‡∏•</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß</th>
                            <th>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</th>
                            <th>‡∏´‡πâ‡∏≠‡∏á</th>
                            <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                            <th>‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°</th>
                        </tr>
                    </thead>
                    <tbody id="teacherTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwIEF0K4z7d9i1YnCVqTpXoaA_chCOBCS3SPIdM1sTz1afydtgfGmjY8a2jz9oKpUQc/exec";
        let clubData = [];
        let teacherName = "";
        let clubName = "";

        // 1. Login ‡∏Ñ‡∏£‡∏π
        async function checkTeacherLogin() {
            const email    = document.getElementById('teacher-email').value;
            const password = document.getElementById('teacher-password').value;

            if (!email || !password) {
                alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
                return;
            }

            const btn = document.querySelector('#teacher-login .btn-main');
            btn.disabled = true;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...";

            try {
                const res = await fetch(`${SCRIPT_URL}?action=verifyTeacher&email=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`);
                const result = await res.json();

                if (result.status === "ok") {
                    teacherName = result.teacherName;
                    clubName    = result.club;

                    sessionStorage.setItem('teacherLoggedIn', 'true');
                    sessionStorage.setItem('teacherName', teacherName);
                    sessionStorage.setItem('clubName', clubName);

                    showTeacherContent();
                } else {
                    alert("‚ùå ‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
                }
            } catch (err) {
                alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà");
            } finally {
                btn.disabled = false;
                btn.innerText = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö";
            }
        }

        // 2. ‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏£‡∏π
        function showTeacherContent() {
            document.getElementById('teacher-login').style.display = 'none';
            document.getElementById('teacher-content').style.display = 'block';
            document.getElementById('teacher-info').innerText = `‡∏Ñ‡∏£‡∏π${teacherName}`;
            document.getElementById('club-name-display').innerText = `üìã ${clubName}`;
            loadClubData();
        }

        // 3. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°
        async function loadClubData() {
            const tbody = document.getElementById('teacherTableBody');
            tbody.innerHTML = "<tr><td colspan='8'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>";

            try {
                const res = await fetch(`${SCRIPT_URL}?action=readByClub&club=${encodeURIComponent(clubName)}`);
                clubData = await res.json();
                renderTable(clubData);
                document.getElementById('student-count').innerText = `‡∏à‡∏≥‡∏ô‡∏ß‡∏ô ${clubData.length} ‡∏Ñ‡∏ô`;
            } catch (err) {
                tbody.innerHTML = "<tr><td colspan='8'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>";
            }
        }

        // 4. ‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        function renderTable(data) {
            const tbody = document.getElementById('teacherTableBody');
            tbody.innerHTML = "";
            if (data.length === 0) {
                tbody.innerHTML = "<tr><td colspan='8' style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</td></tr>";
                return;
            }
            data.forEach((row) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row[0]}</td>
                    <td>${row[1]}</td>
                    <td>${row[2]}</td>
                    <td>${row[3]}</td>
                    <td>${row[4]}</td>
                    <td>${row[5]}</td>
                    <td>${row[6]}</td>
                    <td class="club-cell">${row[7]}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 5. ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        function searchTable() {
            const input = document.getElementById("teacherSearch").value.toLowerCase();
            const rows = document.getElementById("teacherTableBody").getElementsByTagName("tr");
            for (let row of rows) {
                row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
            }
        }

        // 6. Export Excel
        function exportExcel() {
            if (clubData.length === 0) {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Export");
                return;
            }
            const exportData = clubData.map(row => ({
                "‡∏ß/‡∏î/‡∏õ":         row[0],
                "‡πÄ‡∏ß‡∏•‡∏≤":          row[1],
                "‡∏≠‡∏µ‡πÄ‡∏°‡∏•":         row[2],
                "‡πÄ‡∏•‡∏Ç‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß":  String(row[3]).replace("'", ""),
                "‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà":        row[4],
                "‡∏´‡πâ‡∏≠‡∏á":         String(row[5]).replace("'", ""),
                "‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•": row[6],
                "‡∏ä‡∏∏‡∏°‡∏ô‡∏∏‡∏°":        row[7]
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô");
            XLSX.writeFile(wb, `‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠_${clubName}.xlsx`);
        }

        // 7. ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
        function logoutTeacher() {
            sessionStorage.removeItem('teacherLoggedIn');
            sessionStorage.removeItem('teacherName');
            sessionStorage.removeItem('clubName');
            document.getElementById('teacher-content').style.display = 'none';
            document.getElementById('teacher-login').style.display = 'flex';
            document.getElementById('teacher-email').value = '';
            document.getElementById('teacher-password').value = '';
        }

        // 8. ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Login ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤
        window.onload = function() {
            if (sessionStorage.getItem('teacherLoggedIn') === 'true') {
                teacherName = sessionStorage.getItem('teacherName');
                clubName    = sessionStorage.getItem('clubName');
                showTeacherContent();
            }
        }
    </script>

    <style>
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f4f4f4; display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { width: 320px; text-align: center; }
        .login-card input { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .table-wrapper { overflow-x: auto; background: white; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 12px; border: 1px solid #eee; text-align: left; }
        th { background-color: var(--br-red); color: white; }
        .club-cell { font-weight: bold; color: var(--br-red); }
        .btn-export { background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; white-space: nowrap; }
    </style>
</body>
</html>